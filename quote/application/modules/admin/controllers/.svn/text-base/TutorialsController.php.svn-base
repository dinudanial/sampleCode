<?php
include_once 'IptController.php';
class Admin_TutorialsController extends admin_IptController
{


    public function indexAction()
    {
        $formTutorialGroup=new admin_Form_NewTutorialGroup();
        $this->view->formgroup=$formTutorialGroup;
        
        $formTutorial=new admin_Form_NewTutorial();
        $this->view->formtutorial=$formTutorial;
        
        $tutorial=new admin_Model_Tutorial();
        $t=$tutorial->listTutorials();
        
        $arr = array('tutoriallist'=> $t);
        $this->view->assign($arr);
       
    }
    
    public function savetutorialgroupAction()
    {
         $this->_helper->viewRenderer->setNoRender(true);
          if ($this->_request->isPost()) {
               $formData = $this->_request->getPost();
               $tutorialGroup = new admin_Model_TutorialGroup();
               $tutorialGroup->setGroupName($formData['tutorialname']);
               $result=$tutorialGroup->saveTutorialGroups($tutorialGroup);
               if($result!==null)
               {
                   $tgjson=array();
                   $tGroupsDetails=$tutorialGroup->getAllTutorialGroups();
                   if($tGroupsDetails!=null)
                   {
                      foreach($tGroupsDetails as $tgDetails)
                      {
                         $json=  admin_Model_TutorialGroup::getJson($tgDetails);
                         $tgjson[]=$json;
                      }
                    echo Zend_Json::encode($tgjson);exit;
                      
                   }
                 
                   
               }
          }
        
    }
    
    
    public function savetutorialAction()
    {
           $formTutorial=new admin_Form_NewTutorial();
           $this->_helper->viewRenderer->setNoRender(true);
           if ($this->_request->isPost()) {
                $formData = $this->_request->getPost();
               
                if ($formTutorial->isValid($formData)) {
                  
                        $tutorial = new admin_Model_Tutorial();
                        $current=  getcwd(); 
                        $upload = new Zend_File_Transfer_Adapter_Http();              
                        $upload->setDestination($current.'/uploads/tutorials');
                        $files = $upload->getFileInfo();
                        if($files['htmlfile']['name']!="" ||     $files['pdffile']['name']!="")
                        {
                           
                                if($files['htmlfile']['name']!="")
                                {
                                    $tutorial->setFileHtml($files['htmlfile']['name']); 
                                }
                                else
                                {
                               
                                    echo "html file is null";
                                }
                                if($files['pdffile']['name']!="")
                                {
                               
                                $tutorial->setFilePdf($files['pdffile']['name']);
                                }
                                else
                                {
                                    echo "html file is null";
                                }
                        
                        
                          
                          foreach ($files as $file => $info) {
                            if($upload->isValid($file)){
                                        $upload->receive($file);      
                          }
                          else
                          {
                                   print_r ($upload->getErrors());
                          }   
                        }
                
                     }
                     
                    
                     if($formData['hiddenid']=="")
                     {  
                     
                       $tutorial->setTutorialName($formData['tutorialname']);
                       $tutorial->setGroupId($formData['tutorialgrouptutorial']);
                       $tutorial->setCreatedDate(date('Y-m-d', strtotime($formData['dateuploaded'])));
                    
                       $result=$tutorial->saveTutorials($tutorial);             
                       $this->_redirect("/admin/Tutorials");
                    } 
                    else
                    {
                
                       $tutorial->setId((integer)$formData['hiddenid']);
                       $tutorial->setTutorialName($formData['tutorialname']);
                       $tutorial->setGroupId($formData['tutorialgroup']);
                       $tutorial->setCreatedDate(date('Y-m-d', strtotime($formData['dateuploaded'])));
                       $result=$tutorial->editTutorials($tutorial);
                       $this->_redirect("/admin/Tutorials");
                  }
                    
                }
           }
    }
    
    
    public function gettutorialdetailsAction()
    {
        $this->_helper->viewRenderer->setNoRender(true);
         if ($this->_request->isPost()) {
                  $tutorialid=  $this->_request->getPost('tutorialId');
                  $tutorial=new admin_Model_Tutorial();
                  $tutorialDetails=$tutorial->getTutorialDetail((integer)$tutorialid);
             
                  $json=  admin_Model_Tutorial::getJson($tutorialDetails);
                  echo $json;exit;
           
         }
    }
    
    public function deletetutorialAction()
    {
        $this->_helper->viewRenderer->setNoRender(true);
         if ($this->_request->isPost()) {
               $tutorialid=  $this->_request->getPost('tutorialId');
               $tutorial=new admin_Model_Tutorial();
               $tutorial->deleteTutorial((integer)$tutorialid);
              
         }
    }
    
    public function downloadtutorialAction()
    {
         $this->_helper->viewRenderer->setNoRender(true);
     
               $tutorialid= $this->getRequest()->getParam('tid');
               $type=$this->getRequest()->getParam('type');
              
               $current = getcwd();
               $tutorial=new admin_Model_Tutorial();
               $files=$tutorial->getFilename((integer)$tutorialid);
               if($type=="pdf")
               {
                        $file = $current . '/uploads/tutorials/'.$files['d__Pdf'];
                            if (file_exists($file)) {
                        header('Content-Description: File Transfer');
                        header('Content-Disposition: attachment; filename=' . basename($file));
                        header('Content-type: application/pdf'); 
                        header('Expires: 0');
                        header('Cache-Control: must-revalidate');
                        header('Pragma: public');
                        header('Content-Length: ' . filesize($file));
                        ob_clean();
                        flush();
                        readfile($file);
                        exit;

                        }
                        else
                        {
                            echo "File Not Found to download";
                        }
               }
               else
               {
                       $file = $current . '/uploads/tutorials/'.$files['d__Html'];
                            if (file_exists($file)) {
                        header('Content-Description: File Transfer');
                        header('Content-Disposition: attachment; filename=' . basename($file));
                        header('Content-type: application/x-empty'); 
                        header('Expires: 0');
                        header('Cache-Control: must-revalidate');
                        header('Pragma: public');
                        header('Content-Length: ' . filesize($file));
                        ob_clean();
                        flush();
                        readfile($file);
                        exit;

                        }
                        else
                        {
                            echo "File Not Found to download";
                        }
               }
        
    }
        
}

