<?php
include_once 'IptController.php';
class Admin_CountriesController extends admin_IptController {

   

    public function indexAction() {
        $r = new admin_Model_Region();

        $regions = $r->getAllRegions();
        $arr = array('regions' => $regions);
        $this->view->assign($arr);
        $form = new admin_Form_CountryAdd;
        $this->view->form = $form;
    }

    public function getcountrydetailsAction() {

//           $this->_helper->viewRenderer->setNoRender(true);
        if ($this->_request->isPost()) {
            $CountryId = $this->getRequest()->getPost('countryId');
            $Country = new admin_Model_Country();
            $countryDetails = $Country->find((integer) $CountryId);
            $json = admin_Model_Country::getJson($countryDetails);
            echo $json;
            exit;
        }
    }


    public function savecountryAction()
     {
    $this->_helper->viewRenderer->setNoRender(true);
    $form=new admin_Form_CountryAdd();
          if ($this->_request->isPost()) {
               $formData = $this->_request->getPost();
    		
                 if ($form->isValid($formData)) {
                        $country = new admin_Model_Country();
          
                        $current=  getcwd();                       
                        $upload = new Zend_File_Transfer_Adapter_Http();              
                        $upload->setDestination($current.'/uploads/files');
                        try{
                              $file=new admin_Model_File();
                              if($formData['hidenFileId']){
                                  $file->setId((integer)$formData['hidenFileId']);                              
                              }
                              $file->setDescription($formData['filedescription']);
                              if($upload->receive())
                              {
                                  /* todo-- ID_user should be set */
                                 // $file=new admin_Model_File();
                                  $file->setName($_FILES['doc_path']['name']);
                                  $file->setFileName($_FILES['doc_path']['name']);
                                  $file->setType($_FILES['doc_path']['type']);
                                  $file->setCountry($formData['countryid']);
                                  $file->setFileSize($_FILES['doc_path']['size']);
                                  $file->setFileType($_FILES['doc_path']['type']);
                                 
                                  
                              }
                              else
                              {
                                  print_r ($upload->getErrors());
                              }
                               $country->setFile($file);
                        }
                        catch (Zend_File_Transfer_Exception $e){
                            $e->getMessage();
                        }
                     
                        $country->setId((integer)$formData['countryid']);     
                        $country->setCountry($formData['name']);
                        $country->setAuthorised($formData['autherised']);
                        $country->setAdmittedType($formData['admitted_type']);
                        $country->setStandingDataApplicable((integer)$formData['sendingDataApplicable']);
                        if($formData['defaultAdmittedEntry']!='select'  && $country->getAdmittedType()==0)
                        	$country->setAdmittedEntry($formData['defaultAdmittedEntry']);
                        else if($formData['defaultAdmittedEntry1']!='select' && $country->getAdmittedType()==1)
                        	$country->setAdmittedEntry($formData['defaultAdmittedEntry1']);
                        $country->setResidencePullDown((boolean)$formData['residenceDropDown']);
                        $country->setLockAdmitted((boolean)$formData['lockAdmitted']);
                        $country->setLpan((boolean)$formData['lpan']);
                        $country->setCommentary($formData['countrycommentary']); 
                        $resultArray=$country->save($country);
                        //$this->_forward('index','countries','admin');
                        $this->_redirect("/admin/countries");                        
                              
               } else {
                     $form->populate($formData);
               }
         }

    }
    public function downloadAction(){
        $this->_helper->viewRenderer->setNoRender(true);
        $fileId = $this->getRequest()->getParam('fileId');
        $fileName =  $this->getRequest()->getParam('fileName');
        $file =  getcwd() . '/uploads/files/'.$fileName;
        if (file_exists($file)) {
            header('Content-Description: File Transfer');
            header('Content-Type: application/octet-stream');
            header('Content-Disposition: attachment; filename=' . basename($file));
            header('Content-Transfer-Encoding: binary');
            header('Expires: 0');
            header('Cache-Control: must-revalidate');
            header('Pragma: public');
            header('Content-Length: ' . filesize($file));
            ob_clean();
            flush();
            readfile($file);
            exit;
         }
    }
    
    public function deletefileAction(){
         $this->_helper->viewRenderer->setNoRender(true);
          if ($this->_request->isPost()) {
               $fileId = (integer)$this->_request->getPost('fileId');
               $fileName = $this->_request->getPost('fileName');
               if($fileId){
                   $status = array();
                   $status['status']= false;
                   $file = new admin_Model_File();
                   $result = $file->deleteFile($fileId);
                   if($result){
                        $status['status'] = true;
                        @unlink(getcwd() . '/uploads/files/'.$fileName);
                   }
                      
                   echo  Zend_Json::encode($status);exit;
               }else{
                   throw new Exception("Invalid file Id");
               }
          }
    }

}

