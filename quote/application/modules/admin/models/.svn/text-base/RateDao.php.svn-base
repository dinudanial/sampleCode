<?php

class admin_Model_RateDao extends Zend_Db_Table_Abstract {

    protected $_name = 'RateMaster';
    protected $_primary = 'ID_RateMaster';

    public function getRates(array $filter) {
        try {
            $select = $this->select()
                    ->from($this, array('ID_RateMaster', 'ID_InsuranceClass',
                        'ID_Currency', 'ID_Country', 'd__ObsoleteRatec',
                        'd__InsuredResidenceApplicable', 'd__DefaultSubClass',
                        's__CreationAccount', 'd__TypeOfTax','d__TertiaryClass', 
                        'd__TaxSubClass', 'd__NoAutoCreate','s__CreationTimestamp'
                        ))
                 
                    -> join('Country', 'Country.ID_Country = RateMaster.ID_Country', array('Country.d__CountryName'))
             	    -> join('InsuranceClass', 'InsuranceClass.ID_InsuranceClass = RateMaster.ID_InsuranceClass', array('InsuranceClass.d__InsuranceClass'))
                    -> join('Region', 'Region.ID_Region = Country.ID_Region', array('Region.d__RegionName'))
                    -> join('Currency', 'Currency.ID_Currency = RateMaster.ID_Currency', array('Currency.d__CurrencyName'))
                    ->setIntegrityCheck(false)
                    ->where('RateMaster.ID_Country = ?', $filter['country']);
         	if (isset($filter['insuranceClass']) && !empty($filter['insuranceClass'])) {
                $select->where('RateMaster.ID_InsuranceClass = ?', $filter['insuranceClass']);
            }
            if (isset($filter['dataIssue']) && !empty($filter['dataIssue'])) {
                $select->where('RateMaster.s__DataIssue = ?', $filter['dataIssue']);
            }
            if (isset($filter['rateId']) && !empty($filter['rateId'])) {
                $select->where('RateMaster.ID_RateMaster = ?', $filter['rateId']);
            }
            $stmt = $select->query();
            $rows = $stmt->fetchAll();
            if (count($rows) > 0){
                return $rows;
            }
            else
                return false;
        } catch (Zend_Db_Table_Exception $ex) {
            throw new Exception($ex->getMessage());
        }
    }

    public function saveRate(array $rateDetails) {
        try {
            $result = $this->insert($rateDetails);
            return true;
        } catch (Zend_Db_Table_Exception $ex) {
            throw new Exception($ex->getMessage());
        }
    }

    public function editRate(array $rateDetails) {
        try {
        	//echo "<pre>";
            //print_r($rateDetails);exit;
            $where['ID_RateMaster = ?'] = $rateDetails['ID_RateMaster'];
            $this->update($rateDetails,$where);
            return true;
        } catch (Zend_Db_Table_Exception $ex) {
            throw new Exception($ex->getMessage());
        }
    }
    
    public function findRate($rateId){
    	try{
    		$select	= $this->select()
    				->from($this, array('ID_RateMaster', 'ID_InsuranceClass',
                        'ID_Currency', 'ID_Country', 'd__ObsoleteRatec',
                        'd__InsuredResidenceApplicable', 'd__DefaultSubClass',
                        's__CreationAccount', 'd__TypeOfTax','d__TertiaryClass', 
                        'd__TaxSubClass', 'd__NoAutoCreate','s__CreationTimestamp'
                        ))
                        -> join('Country', 'Country.ID_Country = RateMaster.ID_Country', array('Country.d__CountryName','Country.ID_Region'))
             		-> join('InsuranceClass', 'InsuranceClass.ID_InsuranceClass = RateMaster.ID_InsuranceClass', array('InsuranceClass.d__InsuranceClass'))
             		->setIntegrityCheck(false)
                        ->where('RateMaster.ID_RateMaster = ?', $rateId);
            $stmt = $select->query();    		
            $rows = $stmt->fetchAll();
            if (count($rows) > 0){
                return $rows;
            }
            else
                return false;
    	}catch(Zend_Db_Table_Exception $ex){
    		throw new Exception($ex->getMessage());
    	}
    }
    
    public function findDefaultSubclass(array $dataArray){
        try{
            $config = new Zend_Config_Ini(APPLICATION_PATH . '/modules/admin/constants.ini');
            $defaultSubclassValue = $config->get("contants")->get("ratemaster")->get("defaultSubclassValue");
            $select = $this->select()
                ->from($this, array('ID_RateMaster'))
                ->where('ID_Currency = ?',$dataArray['currency'])
    		->where('ID_Country = ?',$dataArray['country'])
    		->where('d__TypeOfTax = ?',$dataArray['typeOfTax'])
                ->where('d__DefaultSubClass = ?',$defaultSubclassValue)
    		->where('ID_InsuranceClass = ?',$dataArray['insuranceclass']);
            $stmt = $select->query();
            $rows = $stmt->fetchAll();
            if (count($rows) > 0){
                return $rows;
            }
            else
                return false;
                    
        }catch(Zend_Db_Table_Exception $ex){
    		throw new Exception($ex->getMessage());
    	}
        
    }


    public function findRateSubclass(array $dataArray){
    	try{
            $select	= $this->select()
            ->from($this, array('ID_RateMaster', 'd__DefaultSubClass','d__TypeOfTax','d__TaxSubClass','tertiaryClass'=>new Zend_Db_Expr('GROUP_CONCAT(d__TertiaryClass,\'##\',ID_RateMaster)')))
            ->join('Country', 'Country.ID_Country = RateMaster.ID_Country', array('Country.d__CountryName'))
            ->join('InsuranceClass', 'InsuranceClass.ID_InsuranceClass = RateMaster.ID_InsuranceClass', array('InsuranceClass.d__InsuranceClass'))
            ->setIntegrityCheck(false)
            ->where('ID_Currency = ?',$dataArray['currency'])
            ->where('RateMaster.ID_Country = ?',$dataArray['country'])
            ->where('d__TypeOfTax = ?',$dataArray['typeoftax'])
            ->where('RateMaster.ID_InsuranceClass = ?',$dataArray['insuranceclass'])
            ->group('d__TaxSubClass');
           
            $stmt = $select->query();
            $rows = $stmt->fetchAll();
            if (count($rows) > 0){
                return $rows;
            }
            else
                return false;
    	}catch(Zend_Db_Table_Exception $ex){
    		throw new Exception($ex->getMessage());
    	}
    	
    }
    
    public function saveDefaultSubClass($quoteId,$subclass){
        try{
            $result = $this->updateDefaultSubclass($subclass);
            if($result){
                $config = new Zend_Config_Ini(APPLICATION_PATH . '/modules/admin/constants.ini');
                $defaultSubclassValue = $config->get("contants")->get("ratemaster")->get("defaultSubclassValue");
                $dataArray = array("d__DefaultSubClass"=>$defaultSubclassValue);
                $where['ID_RateMaster = ?'] = $quoteId;
                $this->update($dataArray,$where);
                return true;
            }else{
                return false;
            }
            }catch(Zend_Db_Table_Exception $ex){
                throw new Exception($ex->getMessage());
            }
    }
    
    public function updateDefaultSubclass($subclass){
        try{
            if($subclass){
                    $subclassUpdateArray = array("d__DefaultSubClass"=>'');
                    $where['ID_RateMaster = ?'] = $subclass;
                    $this->update($subclassUpdateArray,$where);
                    return true;
            }
             else
                return true;
        }catch(Zend_Db_Table_Exception $ex){
             throw new Exception($ex->getMessage());
        }
            
    }
}

