<?php

class Admin_Model_FileDao extends Zend_Db_Table_Abstract {

    protected $_name = 'File';
    protected $_primary = 'ID_File';

    public function saveFile(admin_Model_File $file = null) {
        if (null != $file) {
            try {
                if($file->getId() && !$file->getFileName()){
                    
                    $data =array('d__Description' => $file->getDescription());
                    $where['ID_File = ?'] = $file->getId();
                    $this->update($data, $where);
                }else if($file->getFileName()){
                    $data = array('d__Filename' => $file->getFileName(), 'd__Name' => $file->getName(),
                    'd__Type' => $file->getType(), 'd__Filesize' => $file->getFileSize(),
                    'd__Filetype' => $file->getFileType(), 'ID_Country' => $file->getCountry(),'d__Description' => $file->getDescription());


                    $check = $this->checkFile($file->getCountry());
                    if ($check) {
                        $newRow = $this->createRow($data);
                        $newRow->save();
                    } else {
                        $where['ID_Country=?'] = $file->getCountry();
                        $this->delete($where);
                        $newRow = $this->createRow($data);
                        $newRow->save();
                    }
                }
                
            } catch (Zend_Db_Table_Exception $exc) {
                echo $exc->getMessage();
            }
        }
    }

    public function checkFile($Countryid) {
        try{
            $select = $this->select();
            $select->where('ID_Country=?', $Countryid);
            $stmt = $select->query();
            $rows = $stmt->fetchAll();
            if (count($rows) > 0)
                return false;
            else
                return true;
           } catch (Zend_Db_Table_Exception $e) {
                throw new Exception($e->getMessage());
        }
        
    }
   
    public function find($countryId){
        try{
            $select = $this->select()
                ->from($this, array('d__Description', 'd__Filename', 'd__Name', 
                    'd__Type', 'd__Filesize', 'ID_File','ID_Country'))
                ->where('ID_Country=?', $countryId);
        
            $stmt = $select->query();
            $rows = $stmt->fetchAll();
            if (count($rows) > 0)
                return $rows;
            else
                return false;
        } catch (Zend_Db_Table_Exception $e) {
                throw new Exception($e->getMessage());
        }
        
    }
    
    public function deleteFile($fileId){
        try{
            $where['ID_File = ?'] = $fileId;
            $this->delete($where);
            return true;
        }catch (Zend_Db_Table_Exception $e) {
                throw new Exception($e->getMessage());
        }
    }
}

